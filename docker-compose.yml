version: '3.8'

services:
  # 1. GOLANG BACKEND (Engine & API)
  backend:
    container_name: coconut_gis_backend
    image: golang:1.21-alpine
    command: tail -f /dev/null 
    working_dir: /app
    volumes:
      - ./backend:/app
    ports:
      - "${BACKEND_PORT:-8080}:8080"
    environment:
      - DB_HOST=${DB_HOST:-database}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-coconut_gis_db}
      - REDIS_HOST=${REDIS_HOST:-cache}
      - REDIS_PORT=${REDIS_PORT:-6379}
    depends_on:
      - database
      - cache
    networks:
      - gis_network

  # 2. FRONTEND (Web UI & Cesium Map)
  frontend:
    container_name: coconut_gis_frontend
    image: node:20-alpine
    command: tail -f /dev/null
    working_dir: /app
    volumes:
      - ./frontend:/app
    ports:
      - "${FRONTEND_PORT:-3000}:3000" 
    environment:
      - NODE_ENV=${NODE_ENV:-development}
    networks:
      - gis_network

  # 3. DATABASE (POSTGRESQL + POSTGIS)
  database:
    container_name: coconut_gis_db
    image: postgis/postgis:15-3.4
    restart: always
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME:-coconut_gis_db}
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - gis_network

  # 4. REDIS CACHE
  cache:
    container_name: coconut_gis_cache
    image: redis:7-alpine
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redisdata:/data
    networks:
      - gis_network

networks:
  gis_network:
    driver: bridge

volumes:
  pgdata:
  redisdata: